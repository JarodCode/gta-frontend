<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile - Game Library</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .profile-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .profile-header {
      display: flex;
      align-items: center;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    
    .avatar {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .profile-info {
      flex: 1;
    }
    
    .profile-info h1 {
      margin: 0 0 0.5rem 0;
      font-size: 2.2rem;
    }
    
    .profile-meta {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    
    .bio {
      line-height: 1.5;
      margin-bottom: 1rem;
    }
    
    .reviews-container {
      margin-top: 2rem;
    }
    
    .reviews-container h2 {
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #eee;
    }
    
    .review-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 2rem;
    }
    
    .review-card {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .review-game {
      padding: 1rem;
      background-color: #f9f9f9;
    }
    
    .review-game h3 {
      margin: 0 0 0.5rem 0;
      font-size: 1.2rem;
    }
    
    .review-game-link {
      color: #333;
      text-decoration: none;
    }
    
    .review-game-link:hover {
      text-decoration: underline;
    }
    
    .review-rating {
      display: flex;
      align-items: center;
      color: #f5c518;
    }
    
    .review-content {
      padding: 1rem;
      flex: 1;
    }
    
    .review-date {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
      color: #666;
      background-color: #f5f5f5;
      text-align: right;
    }
    
    .no-reviews {
      text-align: center;
      padding: 2rem;
      color: #666;
      background-color: #f9f9f9;
      border-radius: 8px;
    }
    
    .loading {
      text-align: center;
      padding: 2rem;
    }
    
    .error {
      text-align: center;
      padding: 2rem;
      color: #d32f2f;
      background-color: #ffebee;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <div class="logo">
          <a href="index.html">Game Library</a>
        </div>
        <nav>
          <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="pages/games/list.html">Games</a></li>
            <li id="auth-links">
              <a href="index.html#login">Login</a>
              <a href="index.html#signup">Register</a>
            </li>
            <li id="user-menu" style="display: none;">
              <button id="user-menu-button">
                <span id="username-display">User</span>
                <span class="dropdown-arrow">▼</span>
              </button>
              <div id="user-dropdown" class="dropdown-menu">
                <a href="profile.html">Profile</a>
                <a href="#" id="logout-button">Logout</a>
              </div>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <main>
    <section class="profile-container">
      <div id="profile-content">
        <div class="loading">Loading profile...</div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2023 Game Library. All rights reserved.</p>
    </div>
  </footer>
  
  <script type="module">
    import { getCurrentUser, logout } from './js/auth.js';
    
    // Function to format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    }
    
    // Function to generate star rating HTML
    function getStarRating(rating) {
      const fullStars = Math.floor(rating);
      const halfStar = rating % 1 >= 0.5 ? 1 : 0;
      const emptyStars = 5 - fullStars - halfStar;
      
      let stars = '';
      for (let i = 0; i < fullStars; i++) {
        stars += '<i class="fas fa-star">★</i>';
      }
      if (halfStar) {
        stars += '<i class="fas fa-star-half-alt">★</i>';
      }
      for (let i = 0; i < emptyStars; i++) {
        stars += '<i class="far fa-star">☆</i>';
      }
      return stars;
    }
    
    // Function to get URL parameter
    function getUrlParameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      const results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }
    
    // Function to check login status
    async function checkLoginStatus() {
      const user = await getCurrentUser();
      const authLinks = document.getElementById('auth-links');
      const userMenu = document.getElementById('user-menu');
      
      if (user) {
        // User is logged in
        authLinks.style.display = 'none';
        userMenu.style.display = 'block';
        document.getElementById('username-display').textContent = user.username;
        return user;
      } else {
        // User is not logged in
        authLinks.style.display = 'block';
        userMenu.style.display = 'none';
        return null;
      }
    }
    
    // Function to load user profile
    async function loadUserProfile(username) {
      const profileContent = document.getElementById('profile-content');
      
      try {
        // Fetch user profile
        const response = await fetch(`http://localhost:8080/api/users/${username}`, {
          credentials: 'include',
        });
        
        if (!response.ok) {
          throw new Error(`Failed to fetch profile: ${response.status}`);
        }
        
        const data = await response.json();
        const { user, reviews } = data;
        
        // Set page title
        document.title = `${user.username}'s Profile - Game Library`;
        
        // Create profile HTML
        let profileHTML = `
          <div class="profile-header">
            <img src="${user.avatar_url}" alt="${user.username}" class="avatar">
            <div class="profile-info">
              <h1>${user.username}</h1>
              <div class="profile-meta">Member since ${formatDate(user.created_at)}</div>
              ${user.bio ? `<div class="bio">${user.bio}</div>` : ''}
            </div>
          </div>
        `;
        
        // Add reviews section
        profileHTML += `
          <div class="reviews-container">
            <h2>Reviews (${reviews.length})</h2>
            ${reviews.length > 0 ? '<div class="review-list">' : '<div class="no-reviews">No reviews yet.</div>'}
        `;
        
        // Add review cards
        if (reviews.length > 0) {
          for (const review of reviews) {
            // Fetch game details for each review
            try {
              const gameResponse = await fetch(`http://localhost:8080/api/games/${review.game_id}`);
              let gameTitle = 'Unknown Game';
              let gameImage = 'img/placeholder.png';
              
              if (gameResponse.ok) {
                const gameData = await gameResponse.json();
                gameTitle = gameData.name || 'Unknown Game';
                gameImage = gameData.background_image || 'img/placeholder.png';
              }
              
              profileHTML += `
                <div class="review-card">
                  <div class="review-game">
                    <a href="pages/games/index.html?id=${review.game_id}" class="review-game-link">
                      <h3>${gameTitle}</h3>
                    </a>
                    <div class="review-rating">
                      ${getStarRating(review.rating)} <span class="rating-value">(${review.rating}/5)</span>
                    </div>
                  </div>
                  <div class="review-content">${review.content}</div>
                  <div class="review-date">${formatDate(review.created_at)}</div>
                </div>
              `;
            } catch (err) {
              console.error('Error fetching game details:', err);
              // Add a fallback review card without game details
              profileHTML += `
                <div class="review-card">
                  <div class="review-game">
                    <a href="pages/games/index.html?id=${review.game_id}" class="review-game-link">
                      <h3>Game #${review.game_id}</h3>
                    </a>
                    <div class="review-rating">
                      ${getStarRating(review.rating)} <span class="rating-value">(${review.rating}/5)</span>
                    </div>
                  </div>
                  <div class="review-content">${review.content}</div>
                  <div class="review-date">${formatDate(review.created_at)}</div>
                </div>
              `;
            }
          }
          
          profileHTML += '</div>'; // Close review-list
        }
        
        profileHTML += '</div>'; // Close reviews-container
        
        // Update the profile content
        profileContent.innerHTML = profileHTML;
        
      } catch (error) {
        console.error('Error loading profile:', error);
        profileContent.innerHTML = `<div class="error">Error loading profile: ${error.message}</div>`;
      }
    }
    
    document.addEventListener('DOMContentLoaded', async () => {
      // Check login status
      const user = await checkLoginStatus();
      
      // Get username from URL or use current user's username
      const usernameFromUrl = getUrlParameter('username');
      const username = usernameFromUrl || (user ? user.username : '');
      
      if (!username) {
        // No username provided and not logged in
        document.getElementById('profile-content').innerHTML = `
          <div class="error">
            <h2>No Profile Selected</h2>
            <p>Please log in to view your profile or provide a username in the URL.</p>
            <p><a href="index.html#login" class="btn">Login</a></p>
          </div>
        `;
        return;
      }
      
      // Load user profile
      await loadUserProfile(username);
      
      // Handle user menu dropdown toggle
      const userMenuButton = document.getElementById('user-menu-button');
      const userDropdown = document.getElementById('user-dropdown');
      
      if (userMenuButton) {
        userMenuButton.addEventListener('click', () => {
          userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block';
        });
      }
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (userMenuButton && userDropdown && e.target !== userMenuButton && !userMenuButton.contains(e.target)) {
          userDropdown.style.display = 'none';
        }
      });
      
      // Handle logout
      document.getElementById('logout-button')?.addEventListener('click', async (e) => {
        e.preventDefault();
        await logout();
        window.location.reload();
      });
    });
  </script>
</body>
</html> 