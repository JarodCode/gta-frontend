<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game Library - Games List</title>
  <link rel="stylesheet" href="../../css/style.css">
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <div class="logo">
          <a href="../../index.html">Game Library</a>
        </div>
        <nav>
          <ul>
            <li><a href="../../index.html">Home</a></li>
            <li><a href="list.html" class="active">Games</a></li>
            <li><a href="../developers.html">Developers</a></li>
            <li><a href="../publishers.html">Publishers</a></li>
            <li><a href="../genres.html">Genres</a></li>
            <li id="auth-links">
              <a href="../login/index.html">Login</a>
              <a href="../register/index.html">Register</a>
            </li>
            <li id="user-menu" style="display: none;">
              <button id="user-menu-button">
                <span id="username-display">User</span>
                <span class="dropdown-arrow">â–¼</span>
              </button>
              <div id="user-dropdown" class="dropdown-menu">
                <a href="../profile.html">Profile</a>
                <a href="#" id="logout-button">Logout</a>
              </div>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <main>
    <section class="games-list">
      <div class="container">
        <div class="section-header">
          <h1>Browse All Games</h1>
          <div class="filters">
            <div class="search-box">
              <input type="text" id="search-input" placeholder="Search games...">
              <button id="search-button">Search</button>
            </div>
            <div class="sort-box">
              <label for="sort-select">Sort by:</label>
              <select id="sort-select">
                <option value="user-rating" selected>User Rating</option>
                <option value="name">Name</option>
                <option value="release-date">Release Date</option>
              </select>
            </div>
          </div>
        </div>
        <div id="games-container" class="games-grid">
          <!-- Games will be loaded here -->
          <div class="loading">Loading games...</div>
        </div>
        <div class="pagination">
          <button id="prev-page" class="pagination-button" disabled>Previous</button>
          <span id="page-info">Page 1</span>
          <button id="next-page" class="pagination-button">Next</button>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2023 Game Library. All rights reserved.</p>
    </div>
  </footer>
  
  <script type="module">
    import { fetchGames, transformGameData } from '../../js/api.js';
    import { getCurrentUser, logout } from '../../js/auth.js';
    import { getGamesSortedByUserRating } from '../../js/reviews.js';
    import { getHardcodedGames } from '../../js/hardcoded-games.js';
    
    // Global cache for games
    let gamesCache = {
      data: null,
      timestamp: 0,
      expiry: 24 * 60 * 60 * 1000 // 24 hours in milliseconds
    };
    
    // Function to check if user is logged in
    async function checkLoginStatus() {
      const user = await getCurrentUser();
      const authLinks = document.getElementById('auth-links');
      const userMenu = document.getElementById('user-menu');
      
      if (user) {
        // User is logged in
        authLinks.style.display = 'none';
        userMenu.style.display = 'block';
        document.getElementById('username-display').textContent = user.username;
        return true;
      } else {
        // User is not logged in
        authLinks.style.display = 'block';
        userMenu.style.display = 'none';
        return false;
      }
    }
    
    document.addEventListener('DOMContentLoaded', async () => {
      // Check if user is logged in
      await checkLoginStatus();
      
      // User menu dropdown toggle
      const userMenuButton = document.getElementById('user-menu-button');
      const userDropdown = document.getElementById('user-dropdown');
      
      if (userMenuButton) {
        userMenuButton.addEventListener('click', (e) => {
          userDropdown.style.display = userDropdown.style.display === 'block' ? 'none' : 'block';
        });
      }
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (e.target !== userMenuButton && !userMenuButton.contains(e.target)) {
          userDropdown.style.display = 'none';
        }
      });
      
      // Logout functionality
      document.getElementById('logout-button')?.addEventListener('click', async (e) => {
        e.preventDefault();
        await logout();
        window.location.reload();
      });
      
      // Games list functionality
      const gamesContainer = document.getElementById('games-container');
      const searchInput = document.getElementById('search-input');
      const searchButton = document.getElementById('search-button');
      const sortSelect = document.getElementById('sort-select');
      const prevPageButton = document.getElementById('prev-page');
      const nextPageButton = document.getElementById('next-page');
      const pageInfo = document.getElementById('page-info');
      
      // State variables
      let currentPage = 1;
      let searchQuery = '';
      let allGames = []; // Store all fetched games
      let totalPages = 0;
      
      // Load cache from localStorage on page load
      try {
        const cachedData = localStorage.getItem('gamesCache');
        if (cachedData) {
          const parsed = JSON.parse(cachedData);
          // Check if cache is still valid (less than 24 hours old)
          if (Date.now() - parsed.timestamp < gamesCache.expiry) {
            gamesCache.data = parsed.data;
            gamesCache.timestamp = parsed.timestamp;
            console.log('Loaded games data from localStorage cache');
          } else {
            console.log('Cache expired, will fetch fresh data');
          }
        }
      } catch (e) {
        console.warn('Failed to load games from localStorage:', e);
      }
      
      // Initial load of games
      await loadGames();
      
      // Search functionality
      searchButton.addEventListener('click', async () => {
        searchQuery = searchInput.value.trim();
        currentPage = 1;
        await loadGames();
      });
      
      // Enter key in search box
      searchInput.addEventListener('keyup', async (e) => {
        if (e.key === 'Enter') {
          searchQuery = searchInput.value.trim();
          currentPage = 1;
          await loadGames();
        }
      });
      
      // Sort functionality
      sortSelect.addEventListener('change', async () => {
        const sortBy = sortSelect.value;
        currentPage = 1;
        
        // Make sure games have user ratings before sorting
        allGames = await enhanceGamesWithUserRatings(allGames);
        
        // Sort the games we already have
        if (sortBy === 'user-rating') {
          console.log('Sorting games by user ratings');
          // Sort by user ratings (highest first)
          allGames.sort((a, b) => {
            // If both have user ratings, compare them
            if (a.user_rating_count > 0 && b.user_rating_count > 0) {
              return b.user_rating - a.user_rating;
            }
            // If only a has user ratings, it comes first
            if (a.user_rating_count > 0) return -1;
            // If only b has user ratings, it comes first
            if (b.user_rating_count > 0) return 1;
            // If neither has user ratings, sort alphabetically
            return a.name.localeCompare(b.name);
          });
        } else if (sortBy === 'name') {
          allGames.sort((a, b) => a.name.localeCompare(b.name));
        } else if (sortBy === 'release-date') {
          allGames.sort((a, b) => {
            const dateA = new Date(a.released || '1970-01-01');
            const dateB = new Date(b.released || '1970-01-01');
            return dateB - dateA;
          });
        }
        
        // Display the first page of sorted games
        displayPageOfGames();
        updatePagination();
      });
      
      // Pagination functionality
      prevPageButton.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          displayPageOfGames();
          updatePagination();
        }
      });
      
      nextPageButton.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          displayPageOfGames();
          updatePagination();
        }
      });
      
      // Function to load games
      async function loadGames() {
        const loadingMessage = document.querySelector('.loading');
        
        try {
          loadingMessage.textContent = 'Loading games...';
          loadingMessage.style.display = 'block';
          
          // Get search term and filter parameters from URL
          const urlParams = new URLSearchParams(window.location.search);
          const searchTerm = urlParams.get('search') || searchQuery;
          const developerId = urlParams.get('developer');
          const publisherId = urlParams.get('publisher');
          const genreId = urlParams.get('genre');
          
          // Update page title based on filter
          await updatePageTitle(developerId, publisherId, genreId);
          
          // Update search input if there's a search term
          if (searchTerm) {
            document.getElementById('search-input').value = searchTerm;
          }
          
          // Fetch games data
          console.log('Fetching games data with params:', { searchTerm, developerId, publisherId, genreId });
          const data = await fetchGames({
            search: searchTerm,
            developer: developerId,
            publisher: publisherId,
            genre: genreId,
            page: 1,
            pageSize: 100,
            ordering: '-metacritic'
          });
          
          // Handle the data based on its format
          let games = [];
          if (Array.isArray(data)) {
            // If data is already an array of games
            console.log(`Received ${data.length} games directly as array`);
            games = data;
          } else if (data && data.results && Array.isArray(data.results)) {
            // If data has a results array (API response format)
            console.log(`Received ${data.results.length} games in results array`);
            games = data.results;
          } else {
            console.warn('Unexpected data format:', data);
            throw new Error('Unexpected data format received from API');
          }
          
          // Transform the games data if needed
          allGames = games.map(game => {
            // Check if game needs transformation
            return typeof game.transform === 'function' ? game.transform() : game;
          });
          
          console.log(`Processed ${allGames.length} games`);
          
          // IMPORTANT: Enhance games with user rating data
          allGames = await enhanceGamesWithUserRatings(allGames);
          
          // Calculate total pages based on actual games received
          totalPages = Math.ceil(allGames.length / 10);
          console.log(`Total games: ${allGames.length}, pages: ${totalPages}`);
          
          // Apply initial sort if selected
          const sortBy = sortSelect.value;
          console.log(`Initial sort: ${sortBy}`);
          
          if (sortBy === 'user-rating') {
            // Sort by user ratings (highest first)
            allGames.sort((a, b) => b.rating - a.rating);
          } else if (sortBy === 'name') {
            allGames.sort((a, b) => (a.title || a.name || '').localeCompare(b.title || b.name || ''));
          } else if (sortBy === 'release-date') {
            allGames.sort((a, b) => {
              const dateA = new Date(a.released || a.release_date || '1970-01-01');
              const dateB = new Date(b.released || b.release_date || '1970-01-01');
              return dateB - dateA;
            });
          }
          
          // Clear loading message
          loadingMessage.style.display = 'none';
          
          // Display first page of games
          currentPage = 1;
          displayPageOfGames();
          updatePagination();
          
        } catch (error) {
          console.error('Error loading games:', error);
          loadingMessage.textContent = `Error loading games. Please try again later. Error details: ${error.message}`;
          loadingMessage.style.color = 'red';
        }
      }
      
      // Function to enhance games with user ratings
      async function enhanceGamesWithUserRatings(games) {
        try {
          // Fetch ratings from API
          const response = await fetch("http://localhost:8080/api/games/ratings");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const ratings = await response.json();
          
          // Map ratings to games
          return games.map(game => {
            // Find rating for this game
            const gameRating = ratings.find(r => r.game_id === game.id.toString());
            
            // Add rating to game object
            return {
              ...game,
              rating: gameRating ? Number(gameRating.average_rating) : 0,
              ratingCount: gameRating ? gameRating.rating_count : 0
            };
          });
        } catch (error) {
          console.error("Error fetching game ratings:", error);
          // Return original games if there's an error
          return games.map(game => ({
            ...game,
            rating: 0,
            ratingCount: 0
          }));
        }
      }
      
      // Function to display current page of games
      function displayPageOfGames() {
        const startIndex = (currentPage - 1) * 10;
        const endIndex = startIndex + 10;
        const gamesForCurrentPage = allGames.slice(startIndex, endIndex);
        
        // Display these games
        displayGames(gamesForCurrentPage);
      }
      
      // Function to render games to the page
      function displayGames(games) {
        const gamesContainer = document.getElementById('games-container');
        gamesContainer.innerHTML = '';
        
        if (games.length === 0) {
          gamesContainer.innerHTML = '<div class="no-results">No games found matching your criteria</div>';
          return;
        }
        
        games.forEach(game => {
          const gameCard = document.createElement('div');
          gameCard.className = 'game-card';
          
          // Generate star rating HTML
          const ratingStars = getStarRating(game.rating || 0);
          
          // Safely access game properties with fallbacks
          const title = game.title || game.name || 'Unknown Game';
          const genre = game.genre || 'Uncategorized';
          const thumbnail = game.thumbnail || game.background_image || '../../img/placeholder.png';
          const description = game.short_description || game.description_raw || '';
          const gameId = game.id || 0;
          const rating = game.rating || 0;
          const ratingCount = game.ratingCount || 0;
          
          gameCard.innerHTML = `
            <img src="${thumbnail}" alt="${title}" class="game-thumbnail" onerror="this.src='../../img/placeholder.png'">
            <div class="game-info">
              <h3>${title}</h3>
              <div class="game-meta">
                <span class="game-genre">${genre}</span>
                <div class="game-rating">
                  <span class="stars">${ratingStars}</span>
                  <span class="rating-value">${rating.toFixed(1)}</span>
                  <span class="rating-count">(${ratingCount})</span>
                </div>
              </div>
              <p class="game-description">${truncateText(description, 100)}</p>
              <a href="index.html?id=${gameId}" class="btn btn-primary">View Game</a>
            </div>
          `;
          
          gamesContainer.appendChild(gameCard);
        });
      }
      
      // Function to generate star rating HTML
      function getStarRating(rating) {
        const fullStars = Math.floor(rating);
        const halfStar = rating % 1 >= 0.5 ? 1 : 0;
        const emptyStars = 5 - fullStars - halfStar;
        
        let stars = '';
        for (let i = 0; i < fullStars; i++) {
          stars += '<i class="fas fa-star"></i>';
        }
        if (halfStar) {
          stars += '<i class="fas fa-star-half-alt"></i>';
        }
        for (let i = 0; i < emptyStars; i++) {
          stars += '<i class="far fa-star"></i>';
        }
        return stars;
      }
      
      // Function to truncate text
      function truncateText(text, maxLength) {
        if (!text) return '';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
      }
      
      // Function to update pagination
      function updatePagination() {
        console.log(`Updating pagination: current page ${currentPage}, total pages ${totalPages}`);
        
        prevPageButton.disabled = currentPage <= 1;
        nextPageButton.disabled = currentPage >= totalPages;
        pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
      }
      
      // Function to update page title based on filter
      async function updatePageTitle(developerId, publisherId, genreId) {
        const titleElement = document.querySelector('.section-header h1');
        
        if (developerId) {
          const games = getHardcodedGames();
          const developer = games.flatMap(game => game.developers || [])
            .find(dev => dev.id === parseInt(developerId, 10));
            
          if (developer) {
            titleElement.textContent = `Games by ${developer.name}`;
            document.title = `${developer.name} Games | Game Reviews`;
          }
        } 
        else if (publisherId) {
          const games = getHardcodedGames();
          const publisher = games.flatMap(game => game.publishers || [])
            .find(pub => pub.id === parseInt(publisherId, 10));
            
          if (publisher) {
            titleElement.textContent = `Games by ${publisher.name}`;
            document.title = `${publisher.name} Games | Game Reviews`;
          }
        }
        else if (genreId) {
          const games = getHardcodedGames();
          const genre = games.flatMap(game => game.genres || [])
            .find(g => g.id === parseInt(genreId, 10));
            
          if (genre) {
            titleElement.textContent = `${genre.name} Games`;
            document.title = `${genre.name} Games | Game Reviews`;
          }
        }
      }
    });
  </script>

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
      color: #333;
    }
    
    header {
      background-color: #2c3e50;
      color: white;
      padding: 1em 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .container {
      width: 90%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1em;
    }
    
    .games-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .game-card {
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    
    .game-card:hover {
      transform: translateY(-5px);
    }
    
    .game-card a {
      text-decoration: none;
      color: inherit;
    }
    
    .game-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
    }
    
    .game-card-content {
      padding: 15px;
    }
    
    .game-card h3 {
      margin-top: 0;
      margin-bottom: 5px;
      font-size: 18px;
    }
    
    .game-card .developer {
      color: #666;
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .game-card .description {
      font-size: 14px;
      color: #555;
      margin-top: 8px;
      line-height: 1.4;
      height: 60px;
      overflow: hidden;
    }
    
    .game-icon-container {
      height: 150px;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #f0f0f0;
    }
    
    .game-icon {
      display: inline-block;
      width: 60px;
      height: 60px;
      background-color: #ddd;
      mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 640 512'%3E%3Cpath d='M192 64C86 64 0 150 0 256s86 192 192 192h256c106 0 192-86 192-192S554 64 448 64H192zM496 248c-22.1 0-40-17.9-40-40s17.9-40 40-40s40 17.9 40 40s-17.9 40-40 40zm-24 56c0 22.1-17.9 40-40 40s-40-17.9-40-40s17.9-40 40-40s40 17.9 40 40zM168 200c0-13.3 10.7-24 24-24s24 10.7 24 24v32h32c13.3 0 24 10.7 24 24s-10.7 24-24 24H216v32c0 13.3-10.7 24-24 24s-24-10.7-24-24V280H136c-13.3 0-24-10.7-24-24s10.7-24 24-24h32V200z'/%3E%3C/svg%3E");
      -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 640 512'%3E%3Cpath d='M192 64C86 64 0 150 0 256s86 192 192 192h256c106 0 192-86 192-192S554 64 448 64H192zM496 248c-22.1 0-40-17.9-40-40s17.9-40 40-40s40 17.9 40 40s-17.9 40-40 40zm-24 56c0 22.1-17.9 40-40 40s-40-17.9-40-40s17.9-40 40-40s40 17.9 40 40zM168 200c0-13.3 10.7-24 24-24s24 10.7 24 24v32h32c13.3 0 24 10.7 24 24s-10.7 24-24 24H216v32c0 13.3-10.7 24-24 24s-24-10.7-24-24V280H136c-13.3 0-24-10.7-24-24s10.7-24 24-24h32V200z'/%3E%3C/svg%3E");
      mask-repeat: no-repeat;
      -webkit-mask-repeat: no-repeat;
      mask-position: center;
      -webkit-mask-position: center;
      mask-size: contain;
      -webkit-mask-size: contain;
    }
    
    .rating {
      display: flex;
      align-items: center;
      gap: 5px;
      margin: 0;
    }
    
    .stars {
      color: gold;
      letter-spacing: -3px;
    }
    
    .rating-count {
      font-size: 12px;
      color: #666;
    }
    
    .error {
      grid-column: 1 / -1;
      text-align: center;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      color: #d9534f;
    }
    
    .filters {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }
    
    .filter-group select, .filter-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .nav-menu {
      display: flex;
      justify-content: space-between;
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .nav-menu li {
      padding: 0 15px;
    }
    
    .nav-menu a {
      color: white;
      text-decoration: none;
    }
    
    .nav-menu a:hover {
      text-decoration: underline;
    }
    
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-title {
      margin: 0;
    }
    
    /* User dropdown styles */
    .user-dropdown {
      position: relative;
      cursor: pointer;
    }
    
    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: #f9f9f9;
      min-width: 160px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      z-index: 1;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .dropdown-content a {
      color: #333;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      transition: background-color 0.2s;
    }
    
    .dropdown-content a:hover {
      background-color: #f1f1f1;
    }
    
    .user-dropdown:hover .dropdown-content {
      display: block;
    }
    
    .user-profile {
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
    }
    
    .user-name {
      font-weight: 500;
    }
    
    /* Loading spinner */
    .loading {
      grid-column: 1 / -1;
      text-align: center;
      padding: 20px;
    }
    
    .spinner {
      display: inline-block;
      width: 50px;
      height: 50px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #2c3e50;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    /* Pagination styles */
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 30px;
      gap: 10px;
    }
    
    .pagination button {
      padding: 8px 15px;
      background-color: #2c3e50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .pagination button:hover {
      background-color: #1a2530;
    }
    
    .pagination button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</body>
</html>